---
- name: Deploy Flask web application
  hosts: g1
  become: yes
  vars:
    git_repo: https://github.com/lizbabz/flask-web-app.git
    project_folder: /home/centos/flask-web-app
    app_entry: flaskweb.py
    python_executable: python3
    venv_path: "{{ project_folder }}/venv"

  tasks:
    - name: Install Python3 and virtualenv
      yum:
        name:
          - python3
          - python3-virtualenv
        state: present

    - name: Clone the repository
      git:
        repo: "{{ git_repo }}"
        dest: "{{ project_folder }}"
        clone: yes
        update: yes

    - name: Set up virtual environment
      command: "{{ python_executable }} -m venv {{ venv_path }}"
      args:
        creates: "{{ venv_path }}"

    - name: Install Python packages
      pip:
        requirements: "{{ project_folder }}/requirements.txt"
        virtualenv: "{{ venv_path }}"

    - name: Start Flask application
      shell: "nohup {{ venv_path }}/bin/python {{ project_folder }}/{{ app_entry }} &"
      args:
        chdir: "{{ project_folder }}"
        creates: "{{ project_folder }}/nohup.out"

    - name: Check if the web application is up and running
      uri:
        url: "http://3.17.23.5:5000"
        method: GET
        return_content: yes
      register: result
      failed_when: result.status != 200

...
